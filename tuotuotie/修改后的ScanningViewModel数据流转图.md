# 修改后的ScanningViewModel数据流转图

## 🔄 完整数据流转过程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           📱 PRESENTATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  👆 用户触发扫描操作                                                             │
│                    │                                                             │
│                    ▼                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        UI Screen                                            │ │
│  │  - 调用 scanningViewModel.startScan()                                      │ │
│  │  - 监听 scanState 变化更新扫描状态UI                                         │ │
│  │  - 监听 newDeviceFound 获取新发现的设备列表                                 │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                    │                                                             │
│                    ▼                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    ScanningViewModel                                        │ │
│  │  🎯 核心状态流:                                                              │ │
│  │  - scanState: StateFlow<ScanState>                                         │ │
│  │  - newDeviceFound: SharedFlow<List<BluetoothDevice>> ⭐新增                 │ │
│  │                                                                             │ │
│  │  🎯 核心方法:                                                               │ │
│  │  1️⃣ startScan() → deviceRepository.startScan()                            │ │
│  │  2️⃣ 监听扫描状态 → deviceRepository.getScanState().collect()               │ │
│  │  3️⃣ processDevices() → 批量处理扫描结果                                    │ │
│  │  4️⃣ addDevicesToDb() → 批量添加设备并发送事件                              │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼ deviceRepository.startScan()
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        🧠 BUSINESS LOGIC LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                      DeviceRepository                                       │ │
│  │  1️⃣ startScan() → bleManager.startScan()                                   │ │
│  │  2️⃣ getScanState() → 返回BleManager的scanStateFlow                         │ │
│  │  3️⃣ getDeviceByMacAddress() → 查询设备是否存在                             │ │
│  │  4️⃣ addDevice() → 保存设备到数据库                                          │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼ bleManager.startScan()
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ⚙️ SERVICE LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        BleManager                                           │ │
│  │  - 权限检查、扫描配置、启动扫描                                              │ │
│  │  - ScanCallback处理扫描结果                                                 │ │
│  │  - 发布扫描状态到scanStateFlow                                              │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼ 扫描到BLE广播
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        🎯 EXTERNAL DEVICES                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │         妥妥贴设备广播 (DeepalTag_L0/L1/E1)                                  │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## ⭐ 核心改进：批量新设备处理流程

```
📡 扫描结果回调
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    ScanningViewModel.processDevices()                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  🔍 批量处理扫描结果:                                                            │
│     val newDevices = mutableListOf<BluetoothDevice>()                          │
│                    │                                                             │
│                    ▼                                                             │
│  🔄 遍历所有设备: for (device in devices)                                        │
│     ├─ 检查设备是否存在: deviceRepository.getDeviceByMacAddress()              │
│     ├─ if (deviceNow == null) → newDevices.add(device)                         │
│     └─ 收集所有新设备到列表                                                      │
│                    │                                                             │
│                    ▼                                                             │
│  ✅ 批量处理: if (newDevices.isNotEmpty())                                      │
│     └─ addDevicesToDb(newDevices) ⭐一次性处理多个设备                          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      addDevicesToDb() 批量添加流程                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  1️⃣ 发送事件: _newDeviceFound.emit(devices) ⭐批量发送设备列表                  │
│     📤 UI层接收: SharedFlow<List<BluetoothDevice>>                              │
│                                                                                 │
│  2️⃣ 批量添加到数据库:                                                           │
│     for (device in devices) {                                                  │
│         val deviceName = "DP" + device.name.substring("DeepalTag".length)      │
│         val newDevice = Device(...)                                            │
│         deviceRepository.addDevice(newDevice)                                  │
│     }                                                                           │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         UI层接收批量设备事件                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│  LaunchedEffect(Unit) {                                                        │
│      viewModel.newDeviceFound.collect { devices ->                            │
│          // 处理多个新发现的设备                                                │
│          Log.d("NewDevices", "发现 ${devices.size} 个新设备:")                 │
│          devices.forEach { device ->                                           │
│              Log.d("Device", "- ${device.name} (${device.address})")          │
│          }                                                                     │
│          // 可以显示Toast、更新UI等                                            │
│      }                                                                         │
│  }                                                                             │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 📊 数据结构对比

### ⬅️ **修改前**
```kotlin
// 单设备事件流
val newDeviceFound: SharedFlow<BluetoothDevice>

// 处理方式：逐个处理
for (device in devices) {
    if (deviceNow == null) {
        _newDeviceFound.emit(device)      // 单个发送
        addDeviceToDb(device)             // 单个添加
        break                             // 只处理第一个
    }
}
```

### ➡️ **修改后**
```kotlin
// 批量设备事件流
val newDeviceFound: SharedFlow<List<BluetoothDevice>>

// 处理方式：批量收集和处理
val newDevices = mutableListOf<BluetoothDevice>()
for (device in devices) {
    if (deviceNow == null) {
        newDevices.add(device)            // 收集新设备
    }
}
if (newDevices.isNotEmpty()) {
    _newDeviceFound.emit(newDevices)      // 批量发送
    addDevicesToDb(newDevices)            // 批量添加
}
```

## 🎯 改进优势

### ✅ **性能优化**
- **减少事件频率**: 一次扫描只发送一个事件，包含所有新设备
- **批量数据库操作**: 减少数据库访问次数
- **处理完整性**: 处理扫描结果中的所有新设备，而不仅仅是第一个

### ✅ **用户体验**
- **完整信息**: UI层能获取到所有新发现的设备
- **统一处理**: 可以统一显示"发现 X 个新设备"的提示
- **批量操作**: 支持批量确认或处理多个设备

### ✅ **代码架构**
- **职责清晰**: `processDevices()` 负责收集，`addDevicesToDb()` 负责处理
- **扩展性强**: 容易添加批量验证、批量操作等功能
- **兼容性好**: 保留了单设备处理方法，向后兼容

## 🔄 完整执行时序

```
1. 用户点击扫描 → startScan()
2. BLE扫描启动 → 发现多个设备
3. ScanCallback → ScanResult(devices: List<BluetoothDevice>)
4. processDevices() → 批量检查设备是否存在
5. 收集新设备 → newDevices: List<BluetoothDevice>
6. addDevicesToDb() → 批量处理:
   ├─ emit(newDevices) → UI接收设备列表事件
   └─ 批量添加到数据库
7. UI更新 → 显示新设备信息和操作选项
```

这个改进版本提供了更高效的批量处理能力，同时保持了代码的简洁性和可维护性！
