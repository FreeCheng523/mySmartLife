# 改进的架构设计建议

## 🚫 当前问题分析

### 现有依赖关系
```
DeviceRepository ──依赖──> BleManager
```

### 问题
1. **职责混乱**: Repository既管理数据又处理蓝牙通信
2. **紧耦合**: 难以独立测试和替换蓝牙实现
3. **违反分层**: Repository层不应直接操作硬件抽象层

## ✅ 改进方案

### 方案一：引入 DeviceService 中间层

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  ViewModel      │───>│  DeviceService  │───>│ DeviceRepository│
│  (UI状态管理)    │    │  (设备业务逻辑)  │    │  (数据管理)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   BleManager    │    │   Database      │
                       │  (蓝牙通信)      │    │  (持久化存储)    │
                       └─────────────────┘    └─────────────────┘
```

#### DeviceService 职责：
- 协调 Repository 和 BleManager
- 处理设备业务逻辑
- 事件转换和分发
- 设备状态同步

#### 代码示例：

```kotlin
interface DeviceService {
    // 设备管理
    suspend fun scanDevices(): Flow<ScanState>
    suspend fun connectDevice(macAddress: String): Boolean
    suspend fun disconnectDevice(macAddress: String): Boolean
    
    // 设备控制
    suspend fun setDeviceLedColor(macAddress: String, color: Int): Boolean
    suspend fun setDeviceAntiMisoperation(macAddress: String, enabled: Boolean): Boolean
    
    // 事件流
    fun getDeviceEvents(): Flow<DeviceEvent>
}

@Singleton
class DeviceServiceImpl @Inject constructor(
    private val deviceRepository: DeviceRepository,
    private val bleManager: BleManager
) : DeviceService {
    
    override suspend fun connectDevice(macAddress: String): Boolean {
        // 1. 从Repository获取设备信息
        val device = deviceRepository.getDeviceByMacAddress(macAddress) ?: return false
        
        // 2. 通过BleManager连接
        val bluetoothDevice = bleManager.getDeviceByAddress(macAddress) ?: return false
        val success = bleManager.connect(bluetoothDevice)
        
        // 3. 更新Repository中的状态
        if (success) {
            deviceRepository.updateConnectionState(macAddress, ConnectionState.CONNECTED)
        }
        
        return success
    }
    
    override suspend fun setDeviceLedColor(macAddress: String, color: Int): Boolean {
        // 1. 更新Repository中的配置
        deviceRepository.updateDeviceLedColor(macAddress, color)
        
        // 2. 发送蓝牙命令
        return bleManager.setLedColor(macAddress, color)
    }
}
```

### 方案二：使用事件驱动架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  ViewModel      │───>│ DeviceRepository│    │   BleService    │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 ▼
                    ┌─────────────────────────┐
                    │     EventBus/Flow       │
                    │    (事件总线)            │
                    └─────────────────────────┘
```

#### 特点：
- Repository 只负责数据操作
- BleService 只负责蓝牙通信
- 通过事件总线进行解耦通信

### 方案三：依赖注入接口抽象

```kotlin
// 抽象蓝牙操作接口
interface BluetoothOperations {
    suspend fun scanDevices(): Flow<ScanState>
    suspend fun connectDevice(device: BluetoothDevice): Boolean
    suspend fun sendCommand(macAddress: String, command: ByteArray): Boolean
}

// Repository只依赖抽象接口
class DeviceRepositoryImpl @Inject constructor(
    private val deviceDao: DeviceDao,
    private val bluetoothOps: BluetoothOperations  // 依赖抽象而非具体实现
) : DeviceRepository

// BleManager实现接口
@Singleton
class BleManagerImpl @Inject constructor() : BleManager, BluetoothOperations {
    // 实现具体的蓝牙操作
}
```

## 🎯 推荐方案

### 建议采用 **方案一：DeviceService中间层**

#### 优势：
1. **职责清晰**: 每层都有明确的职责
2. **易于测试**: 可以独立测试每个组件
3. **可扩展**: 易于添加新的设备类型或通信方式
4. **解耦合**: Repository不再直接依赖硬件层

#### 重构步骤：

1. **创建 DeviceService 接口和实现**
2. **将 BleManager 依赖从 Repository 移到 Service**
3. **更新 ViewModel 使用 DeviceService**
4. **重构事件处理逻辑**

#### 最终架构：

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          🎨 PRESENTATION LAYER                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                  │
│  │  HomeViewModel  │  │FunctionViewModel│  │ PairingViewModel│                  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      ↕️
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        🧠 BUSINESS LOGIC LAYER                                  │
│  ┌─────────────────┐                 ┌─────────────────────────────────────────┐ │
│  │  DeviceService  │ ←──────────────→ │        DeviceRepository                 │ │
│  │  (设备业务逻辑)   │                 │         (数据管理)                       │ │
│  └─────────────────┘                 └─────────────────────────────────────────┘ │
│           │                                                                      │
│           ▼                                                                      │
│  ┌─────────────────┐                                                            │
│  │   BleManager    │                                                            │
│  │  (蓝牙通信)      │                                                            │
│  └─────────────────┘                                                            │
└─────────────────────────────────────────────────────────────────────────────────┘
```

这样的设计更符合**单一职责**、**依赖倒置**等SOLID原则，使代码更加清晰、可测试和可维护。

