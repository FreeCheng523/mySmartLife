# 妥妥贴应用架构图

## 🏗️ 整体架构概览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          🎨 PRESENTATION LAYER (UI)                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   MainActivity  │  │   HomeScreen    │  │ FunctionScreen  │  │ PairingScreen│ │
│  │   (Compose容器)  │  │   (设备管理)     │  │   (功能配置)     │  │   (设备配对)  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └──────────────┘ │
│                                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │  HomeViewModel  │  │FunctionViewModel│  │ PairingViewModel│  │LedColorViewModel│
│  │   (状态管理)     │  │   (功能状态)     │  │   (配对状态)     │  │  (LED控制)   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      ↕️
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        🧠 BUSINESS LOGIC LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│  📦 Repositories:                    ⚙️ Function Executors:                     │
│  ┌─────────────────┐                 ┌─────────────────────────────────────────┐ │
│  │ DeviceRepository│ ←──────────────→ │        FunctionExecutor                 │ │
│  │  (设备数据管理)   │                 │         (功能分发器)                     │ │
│  └─────────────────┘                 └─────────────┬───────────────────────────┘ │
│  ┌─────────────────┐                               ↓                             │
│  │SettingsRepository│                 ┌─────────────────────────────────────────┐ │
│  │  (设置管理)      │                 │  AppExecutor  │ CarExecutor │ MediaExecutor│ │
│  └─────────────────┘                 │  (应用功能)   │  (车机功能)  │  (媒体功能)   │ │
│                                       └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      ↕️
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ⚙️ SERVICE LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   BleService    │  │   BleManager    │  │  SoundManager   │  │BootReceiver  │ │
│  │  (蓝牙后台服务)   │  │  (蓝牙连接管理)  │  │   (音效管理)     │  │ (开机启动)   │ │
│  │  - 前台服务      │  │  - 设备扫描     │  │  - 按键音效     │  │ - 自动启动   │ │
│  │  - 连接维持      │  │  - 连接管理     │  │  - 音量控制     │  │              │ │
│  │  - 按键事件处理   │  │  - 数据传输     │  │                │  │              │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      ↕️
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           💾 DATA LAYER                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│  🗄️ Local Storage:              📋 DAOs:                    ⚙️ Configuration:   │
│  ┌─────────────────┐             ┌─────────────────┐        ┌─────────────────┐ │
│  │  Room Database  │ ←─────────→ │   DeviceDao     │        │ FunctionsConfig │ │
│  │   (设备数据)     │             │  (设备数据访问)   │        │  (功能配置文件)  │ │
│  └─────────────────┘             └─────────────────┘        └─────────────────┘ │
│  ┌─────────────────┐             ┌─────────────────┐        ┌─────────────────┐ │
│  │   DataStore     │             │ButtonMappingDao │        │DefaultFunctions │ │
│  │   (应用配置)     │             │ (按键映射访问)   │        │  (默认功能)     │ │
│  └─────────────────┘             └─────────────────┘        └─────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      ↕️
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    🔧 HARDWARE ABSTRACTION LAYER                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│  📡 Bluetooth:            🚗 Car Integration:           🖥️ System Services:      │
│  ┌─────────────────┐      ┌─────────────────┐           ┌─────────────────┐      │
│  │  BleConstants   │      │ Android Car API │           │ Media Controller│      │
│  │   (通信协议)     │      │   (原生车机)     │           │   (媒体控制)     │      │
│  └─────────────────┘      └─────────────────┘           └─────────────────┘      │
│  ┌─────────────────┐      ┌─────────────────┐           ┌─────────────────┐      │
│  │   BleAuth       │      │  MeiJia Car API │           │Package Manager  │      │
│  │   (设备认证)     │      │   (镁佳车机)     │           │  (应用管理)      │      │
│  └─────────────────┘      └─────────────────┘           └─────────────────┘      │
│                           ┌─────────────────┐           ┌─────────────────┐      │
│                           │Virtual Car API  │           │Notification Mgr │      │
│                           │  (虚拟车机)      │           │  (通知管理)      │      │
│                           └─────────────────┘           └─────────────────┘      │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      ↕️
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        🎯 EXTERNAL DEVICES                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────┐    ┌─────────────────────────────────────┐  │
│  │         妥妥贴设备                │    │            车机系统                  │  │
│  │  ┌─────────────────────────────┐ │    │  ┌─────────────────────────────────┐ │  │
│  │  │ DeepalTag_L0 (按键型)        │ │    │  │      镁佳车机平台              │ │  │
│  │  │ DeepalTag_L1 (旋钮型)        │ │    │  │      - 空调控制               │ │  │
│  │  │ DeepalTag_E1 (歌尔型)        │ │    │  │      - 座椅控制               │ │  │
│  │  └─────────────────────────────┘ │    │  │      - 车门控制               │ │  │
│  │  🔗 BLE协议通信                  │    │  └─────────────────────────────────┘ │  │
│  │  📡 UUID: 0xffd0/ffd1/ffd2       │    │  ┌─────────────────────────────────┐ │  │
│  └─────────────────────────────────┘    │  │      梧桐车机平台              │ │  │
│                                         │  │      - 媒体控制               │ │  │
│                                         │  │      - 驾驶模式               │ │  │
│                                         │  │      - 智能灯光               │ │  │
│                                         │  └─────────────────────────────────┘ │  │
│                                         └─────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🏗️ 依赖注入 (Hilt)
```
LingDongTieApp (@HiltAndroidApp)
    ↓
AppModule + BindsModule
    ↓
统一管理所有依赖注入：Repository、BleManager、FunctionExecutor等
```

## 📱 核心功能流程

### 1. 设备配对流程
```
用户启动配对 → PairingScreen → PairingViewModel → BleManager → 
扫描设备 → 连接设备 → 认证 → 保存到数据库 → 显示配对成功
```

### 2. 功能执行流程
```
用户按下妥妥贴 → BLE信号 → BleService → 解析按键事件 → 
FunctionExecutor → 根据功能类型分发 → AppExecutor/CarExecutor/MediaExecutor → 
执行具体功能 → 反馈结果
```

### 3. 功能配置流程
```
用户选择功能 → FunctionScreen → FunctionViewModel → 
读取配置文件 → 显示可用功能 → 用户配置 → 
保存到数据库 → 同步到设备
```

## 🔧 技术栈详细说明

### UI层技术
- **Jetpack Compose**: 现代化声明式UI
- **Material 3**: Google最新设计语言
- **Navigation Compose**: 页面导航管理
- **ViewModel**: MVVM架构状态管理

### 数据层技术
- **Room**: 本地SQLite数据库ORM
- **DataStore**: 替代SharedPreferences的现代存储
- **Flow**: 响应式数据流
- **Coroutines**: 异步编程

### 网络/通信层
- **Android BLE API**: 蓝牙低功耗通信
- **Android Car API**: 原生车机集成
- **厂商车机SDK**: 镁佳、梧桐等平台适配

### 依赖注入
- **Hilt**: Google推荐的DI框架
- **模块化设计**: 按功能划分依赖模块

## 🎯 架构优势

1. **分层清晰**: 六层架构，职责明确
2. **解耦合**: 通过接口和依赖注入实现松耦合
3. **可扩展**: 新增车机平台或功能类型容易扩展
4. **可测试**: 每层都可以独立测试
5. **高性能**: 使用协程和Flow实现高效异步操作
6. **现代化**: 采用Android最新技术栈
