# æ€§èƒ½ä¼˜åŒ–å¿«é€Ÿå‚è€ƒæŒ‡å—

> ğŸ“Œ æœ¬æŒ‡å—æä¾›å¿«é€ŸæŸ¥é˜…çš„ä¼˜åŒ–è¦ç‚¹å’Œä½¿ç”¨æ–¹æ³•

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è¿è¡Œæ€§èƒ½ç›‘æ§

```bash
cd tuotuotie/documents/æ€§èƒ½åˆ†æ
chmod +x æ€§èƒ½ç›‘æ§è„šæœ¬.sh
./æ€§èƒ½ç›‘æ§è„šæœ¬.sh
```

### 2. æ£€æŸ¥ä¼˜åŒ–æ•ˆæœ

```bash
# å¿«é€Ÿæ£€æŸ¥å†…å­˜
adb shell dumpsys meminfo com.deepal.ivi.hmi.smartlife | grep "TOTAL PSS"

# æ£€æŸ¥æ•°æ®åº“è¿æ¥æ•°ï¼ˆåº”è¯¥åªæœ‰1ä¸ªï¼‰
adb shell "lsof | grep lingdong_tie_database | wc -l"
```

---

## ğŸ”§ ä»£ç ä¼˜åŒ–è¦ç‚¹

### âœ… DO - åº”è¯¥è¿™æ ·åš

#### 1. ä½¿ç”¨ LingDongTieManager å•ä¾‹

```kotlin
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ getInstance
val manager = LingDongTieManager.getInstance(
    LingDongTieManager.Builder()
        .setLifecycle(lifecycle)
        // ... å…¶ä»–é…ç½® ...
        .build()
)
```

#### 2. ä½¿ç”¨ ApplicationContext

```kotlin
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ ApplicationContext
private val appContext: Context = context.applicationContext
```

#### 3. æ¸…ç†èµ„æº

```kotlin
// âœ… æ­£ç¡®ï¼šåœ¨ onDestroy ä¸­æ¸…ç†
override fun onDestroy() {
    super.onDestroy()
    mLingDongTieManager?.cleanup()
    mReactiveFlowHandler?.cleanup()
}
```

#### 4. ä½¿ç”¨å¯¹è±¡æ± ï¼ˆæ¨èï¼‰

```kotlin
// âœ… æ¨èï¼šå¤ç”¨å¯¹è±¡
object DevicePool {
    private val pool = ArrayDeque<Device>()
    
    fun obtain(): Device {
        return pool.removeFirstOrNull() ?: Device()
    }
    
    fun recycle(device: Device) {
        device.reset()
        pool.add(device)
    }
}
```

### âŒ DON'T - ä¸åº”è¯¥è¿™æ ·åš

#### 1. ä¸è¦é‡å¤åˆ›å»º Manager

```kotlin
// âŒ é”™è¯¯ï¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°å®ä¾‹
val manager = LingDongTieManager.Builder()
    .build()  // è¿™ä¼šåˆ›å»ºå¤šä¸ªæ•°æ®åº“è¿æ¥ï¼
```

#### 2. ä¸è¦ç›´æ¥ä½¿ç”¨ Activity Context

```kotlin
// âŒ é”™è¯¯ï¼šå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼
private val context: Context  // Activity Context
```

#### 3. ä¸è¦å¿˜è®°æ¸…ç†

```kotlin
// âŒ é”™è¯¯ï¼šæ²¡æœ‰æ¸…ç†èµ„æº
override fun onDestroy() {
    super.onDestroy()
    // å¿˜è®°è°ƒç”¨ cleanup()ï¼
}
```

#### 4. ä¸è¦åˆ›å»ºå¤§é‡ä¸´æ—¶å¯¹è±¡

```kotlin
// âŒ é”™è¯¯ï¼šé¢‘ç¹åˆ›å»ºå¯¹è±¡
fun processData() {
    val tempList = ArrayList<Device>()  // æ¯æ¬¡éƒ½åˆ›å»ºï¼
    // ...
}

// âœ… æ­£ç¡®ï¼šå¤ç”¨å¯¹è±¡
private val tempList = ArrayList<Device>()
fun processData() {
    tempList.clear()
    // ...
}
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡å‚è€ƒ

### æ­£å¸¸èŒƒå›´

| æŒ‡æ ‡ | æ­£å¸¸å€¼ | è¯´æ˜ |
|------|--------|------|
| ç‰©ç†å†…å­˜ (RES) | < 450M | è¶…è¿‡åˆ™éœ€è¦ä¼˜åŒ– |
| CPU ä½¿ç”¨ç‡ | < 5% | å¹³å‡å€¼ |
| CPU å³°å€¼ | < 10% | ç¬æ—¶å³°å€¼ |
| æ•°æ®åº“è¿æ¥ | 1ä¸ª | åªåº”æœ‰1ä¸ªè¿æ¥ |
| çº¿ç¨‹æ•° | < 25 | è¿‡å¤šä¼šå½±å“æ€§èƒ½ |

### å‘Šè­¦é˜ˆå€¼

| æŒ‡æ ‡ | è­¦å‘Šå€¼ | å±é™©å€¼ | å¤„ç†å»ºè®® |
|------|--------|--------|----------|
| å†…å­˜ | 450-500M | > 500M | æ£€æŸ¥å†…å­˜æ³„æ¼ |
| CPU | 5-10% | > 10% | ä¼˜åŒ–ç®—æ³• |
| GC é¢‘ç‡ | æ¯åˆ†é’Ÿ2-3æ¬¡ | æ¯åˆ†é’Ÿ>5æ¬¡ | å‡å°‘å¯¹è±¡åˆ›å»º |

---

## ğŸ” é—®é¢˜æ’æŸ¥

### å†…å­˜å¢é•¿

```bash
# 1. å®æ—¶ç›‘æ§å†…å­˜
watch -n 1 'adb shell dumpsys meminfo com.deepal.ivi.hmi.smartlife | grep TOTAL'

# 2. è·å–è¯¦ç»†å†…å­˜åˆ†æ
adb shell dumpsys meminfo com.deepal.ivi.hmi.smartlife > memory_detail.txt

# 3. æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜æ³„æ¼
# æ¨èä½¿ç”¨ LeakCanary åº“
```

### æ•°æ®åº“é—®é¢˜

```bash
# æ£€æŸ¥æ•°æ®åº“è¿æ¥æ•°
adb shell "lsof | grep lingdong_tie_database"

# åº”è¯¥åªæ˜¾ç¤º1ä¸ªè¿æ¥ï¼Œå¦‚æœæœ‰å¤šä¸ªï¼Œè¯´æ˜å•ä¾‹æ¨¡å¼æ²¡ç”Ÿæ•ˆ
```

### CPU è¿‡é«˜

```bash
# å®æ—¶æŸ¥çœ‹ CPU
adb shell top | grep smartlife

# ä½¿ç”¨ Android Profiler å®šä½çƒ­ç‚¹ä»£ç 
```

---

## ğŸ› ï¸ å¸¸ç”¨å·¥å…·

### ADB å‘½ä»¤

```bash
# è·å–åº”ç”¨ PID
adb shell pidof com.deepal.ivi.hmi.smartlife

# ç›‘æ§ top ä¿¡æ¯
adb shell top -p $(adb shell pidof com.deepal.ivi.hmi.smartlife)

# è·å–å†…å­˜è¯¦æƒ…
adb shell dumpsys meminfo com.deepal.ivi.hmi.smartlife

# è§¦å‘ GC
adb shell am force-stop com.deepal.ivi.hmi.smartlife
```

### æ€§èƒ½ç›‘æ§è„šæœ¬

```bash
# åŸºæœ¬ä½¿ç”¨
./æ€§èƒ½ç›‘æ§è„šæœ¬.sh

# è‡ªå®šä¹‰é—´éš”ï¼ˆæ¯10ç§’é‡‡æ ·ï¼‰
INTERVAL=10 ./æ€§èƒ½ç›‘æ§è„šæœ¬.sh

# è‡ªå®šä¹‰æ—¶é•¿ï¼ˆç›‘æ§10åˆ†é’Ÿï¼‰
DURATION=600 ./æ€§èƒ½ç›‘æ§è„šæœ¬.sh

# ç»„åˆä½¿ç”¨
INTERVAL=10 DURATION=1800 ./æ€§èƒ½ç›‘æ§è„šæœ¬.sh  # æ¯10ç§’ï¼ŒæŒç»­30åˆ†é’Ÿ
```

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### å¼€å‘é˜¶æ®µ

- [ ] ä½¿ç”¨ LingDongTieManager.getInstance() è€Œéç›´æ¥ new
- [ ] ä½¿ç”¨ ApplicationContext è€Œé Activity Context
- [ ] åœ¨ onDestroy() ä¸­è°ƒç”¨ cleanup()
- [ ] é¿å…åœ¨å¾ªç¯ä¸­åˆ›å»ºå¯¹è±¡
- [ ] ä½¿ç”¨å¯¹è±¡æ± å¤ç”¨å¯¹è±¡
- [ ] é™åˆ¶ç¼“å­˜å¤§å°

### æµ‹è¯•é˜¶æ®µ

- [ ] è¿è¡Œæ€§èƒ½ç›‘æ§è„šæœ¬ï¼ˆè‡³å°‘30åˆ†é’Ÿï¼‰
- [ ] æ£€æŸ¥å†…å­˜æ˜¯å¦ç¨³å®šåœ¨ 450M ä»¥ä¸‹
- [ ] ç¡®è®¤æ•°æ®åº“åªæœ‰ 1 ä¸ªè¿æ¥
- [ ] ä½¿ç”¨ LeakCanary æ£€æµ‹å†…å­˜æ³„æ¼
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆé¢‘ç¹æ“ä½œï¼‰
- [ ] é•¿æ—¶é—´è¿è¡Œæµ‹è¯•ï¼ˆ8å°æ—¶ï¼‰

### å‘å¸ƒå‰

- [ ] å®Œæ•´çš„æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
- [ ] å†…å­˜æ³„æ¼æ£€æµ‹é€šè¿‡
- [ ] CPU ä½¿ç”¨ç‡æ­£å¸¸
- [ ] æ— å´©æºƒå’Œ ANR
- [ ] ç”¨æˆ·æ“ä½œæµç•…

---

## ğŸ¯ ä¼˜åŒ–ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰

1. ä½¿ç”¨ LingDongTieManager å•ä¾‹æ¨¡å¼
2. ä¿®å¤ Context æ³„æ¼
3. æ·»åŠ èµ„æºæ¸…ç†æœºåˆ¶

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆæœ¬å‘¨å®Œæˆï¼‰

1. ä¼˜åŒ– ReactiveFlowHandler buffer å¤§å°
2. å®ç°å¯¹è±¡æ± 
3. é™åˆ¶ç¼“å­˜å¤§å°

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰

1. å‡å°‘çº¿ç¨‹æ•°é‡
2. ä¼˜åŒ– APK ä½“ç§¯
3. UI æ¸²æŸ“ä¼˜åŒ–

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½ä¼˜åŒ–å®æ–½æŠ¥å‘Š](./æ€§èƒ½ä¼˜åŒ–å®æ–½æŠ¥å‘Š.md) - è¯¦ç»†çš„ä¼˜åŒ–è¯´æ˜
- [ç»ˆç«¯æ€§èƒ½æ•°æ®åˆ†ææŠ¥å‘Š](./ç»ˆç«¯æ€§èƒ½æ•°æ®åˆ†ææŠ¥å‘Š.md) - åŸå§‹æ€§èƒ½åˆ†æ
- [æ€§èƒ½ç›‘æ§è„šæœ¬](./æ€§èƒ½ç›‘æ§è„šæœ¬.sh) - è‡ªåŠ¨åŒ–ç›‘æ§å·¥å…·

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å†…å­˜ç®¡ç†

```kotlin
// ä½¿ç”¨å¼±å¼•ç”¨
private val weakContext = WeakReference(context)

// ä½¿ç”¨ ApplicationContext
private val appContext = context.applicationContext

// åŠæ—¶æ¸…ç†
override fun onDestroy() {
    super.onDestroy()
    cleanup()
}
```

### 2. å¹¶å‘æ§åˆ¶

```kotlin
// ä½¿ç”¨åç¨‹æ›¿ä»£çº¿ç¨‹
lifecycleScope.launch {
    // å¼‚æ­¥æ“ä½œ
}

// ä½¿ç”¨ Mutex ä¿æŠ¤å…±äº«æ•°æ®
private val mutex = Mutex()
suspend fun update() {
    mutex.withLock {
        // çº¿ç¨‹å®‰å…¨çš„æ“ä½œ
    }
}
```

### 3. å¯¹è±¡å¤ç”¨

```kotlin
// ä½¿ç”¨å¯¹è±¡æ± 
val obj = pool.obtain()
try {
    // ä½¿ç”¨å¯¹è±¡
} finally {
    pool.recycle(obj)
}

// å¤ç”¨é›†åˆ
private val tempList = ArrayList<String>()
fun process() {
    tempList.clear()  // æ¸…ç©ºè€Œä¸æ˜¯åˆ›å»ºæ–°çš„
    // ...
}
```

---

## ğŸ†˜ é‡åˆ°é—®é¢˜ï¼Ÿ

1. **å†…å­˜æŒç»­å¢é•¿** â†’ è¿è¡Œ LeakCanaryï¼ŒæŸ¥çœ‹å†…å­˜æ³„æ¼æŠ¥å‘Š
2. **æ•°æ®åº“è¿æ¥è¿‡å¤š** â†’ æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº† getInstance()
3. **CPU è¿‡é«˜** â†’ ä½¿ç”¨ Android Profiler å®šä½çƒ­ç‚¹ä»£ç 
4. **åº”ç”¨å¡é¡¿** â†’ æ£€æŸ¥ä¸»çº¿ç¨‹æ˜¯å¦æœ‰è€—æ—¶æ“ä½œ

---

**å¿«é€Ÿå‚è€ƒç‰ˆæœ¬**ï¼šv1.0  
**æ›´æ–°æ—¶é—´**ï¼š2025å¹´11æœˆ7æ—¥

