# 妥妥贴应用架构图

```mermaid
graph TB
    %% 用户界面层
    subgraph "Presentation Layer (UI)"
        MainActivity[MainActivity<br/>主界面容器]
        HomeScreen[HomeScreen<br/>设备管理界面]
        FunctionScreen[FunctionScreen<br/>功能配置界面]
        PairingScreen[PairingScreen<br/>设备配对界面]
        SettingScreen[SettingScreen<br/>设备设置界面]
        TestActivity[TestActivity<br/>功能测试界面]
        
        subgraph "ViewModels"
            HomeViewModel[HomeViewModel<br/>主界面状态管理]
            FunctionViewModel[FunctionViewModel<br/>功能配置状态管理]
            PairingViewModel[PairingViewModel<br/>配对流程状态管理]
            LedColorViewModel[LedColorViewModel<br/>LED颜色管理]
        end
    end

    %% 业务逻辑层
    subgraph "Business Logic Layer"
        subgraph "Repositories"
            DeviceRepository[DeviceRepository<br/>设备数据管理]
            SettingsRepository[SettingsRepository<br/>应用设置管理]
        end
        
        subgraph "Function Executors"
            FunctionExecutor[FunctionExecutor<br/>功能执行器接口]
            AppExecutor[AppFunctionExecutor<br/>应用功能执行器]
            CarExecutor[CarFunctionExecutor<br/>车机功能执行器]
            MediaExecutor[MediaFunctionExecutor<br/>媒体功能执行器]
            VirtualCarExecutor[VirtualCarPropertyFunctionExecutor<br/>虚拟车机属性执行器]
            MeiJiaCarExecutor[MeiJiaCarFunctionExecutor<br/>镁佳车机执行器]
        end
    end

    %% 服务层
    subgraph "Service Layer"
        BleService[BleService<br/>蓝牙后台服务]
        BleManager[BleManager<br/>蓝牙连接管理器]
        SoundManager[SoundManager<br/>音效管理器]
        
        subgraph "Receivers"
            BootReceiver[BootCompletedReceiver<br/>开机启动接收器]
        end
    end

    %% 数据层
    subgraph "Data Layer"
        subgraph "Local Storage"
            RoomDB[(Room Database<br/>本地数据库)]
            DataStore[(DataStore<br/>配置存储)]
            SharedPrefs[(SharedPreferences<br/>设置存储)]
        end
        
        subgraph "DAOs"
            DeviceDao[DeviceDao<br/>设备数据访问]
            ButtonMappingDao[ButtonFunctionMappingDao<br/>按键映射数据访问]
        end
        
        subgraph "Configuration"
            FunctionsConfig[FunctionsConfig<br/>功能配置文件]
            DefaultFunctions[DefaultFunctions<br/>默认功能配置]
        end
    end

    %% 硬件抽象层
    subgraph "Hardware Abstraction Layer"
        subgraph "Bluetooth"
            BleConstants[BleConstants<br/>蓝牙通信常量]
            BleAuth[BleAuthUtils<br/>蓝牙认证工具]
        end
        
        subgraph "Car Integration"
            CarAPI[Android Car API<br/>原生车机接口]
            MeiJiaAPI[MeiJia Car API<br/>镁佳车机接口]
            VirtualCarAPI[Virtual Car API<br/>虚拟车机接口]
        end
        
        subgraph "System Services"
            MediaService[Media Controller<br/>媒体控制服务]
            AppService[Package Manager<br/>应用包管理器]
            NotificationService[Notification Manager<br/>通知管理器]
        end
    end

    %% 外部设备
    subgraph "External Devices"
        LingDongTie[妥妥贴设备<br/>DeepalTag_L0/L1/E1]
        CarSystem[车机系统<br/>镁佳/梧桐平台]
    end

    %% 依赖注入
    subgraph "Dependency Injection"
        HiltApp[LingDongTieApp<br/>@HiltAndroidApp]
        AppModule[AppModule<br/>应用级依赖模块]
        BindsModule[BindsModule<br/>接口绑定模块]
    end

    %% 连接关系
    MainActivity --> HomeScreen
    MainActivity --> FunctionScreen
    MainActivity --> PairingScreen
    
    HomeScreen --> HomeViewModel
    FunctionScreen --> FunctionViewModel
    PairingScreen --> PairingViewModel
    
    HomeViewModel --> DeviceRepository
    FunctionViewModel --> DeviceRepository
    FunctionViewModel --> SettingsRepository
    PairingViewModel --> BleManager
    
    DeviceRepository --> DeviceDao
    DeviceRepository --> ButtonMappingDao
    SettingsRepository --> DataStore
    
    DeviceDao --> RoomDB
    ButtonMappingDao --> RoomDB
    
    BleService --> BleManager
    BleService --> FunctionExecutor
    BleService --> SoundManager
    
    FunctionExecutor --> AppExecutor
    FunctionExecutor --> CarExecutor
    FunctionExecutor --> MediaExecutor
    FunctionExecutor --> VirtualCarExecutor
    FunctionExecutor --> MeiJiaCarExecutor
    
    BleManager --> BleConstants
    BleManager --> BleAuth
    BleManager --> LingDongTie
    
    CarExecutor --> CarAPI
    MeiJiaCarExecutor --> MeiJiaAPI
    VirtualCarExecutor --> VirtualCarAPI
    MediaExecutor --> MediaService
    AppExecutor --> AppService
    
    CarAPI --> CarSystem
    MeiJiaAPI --> CarSystem
    
    BootReceiver --> BleService
    
    HiltApp --> AppModule
    HiltApp --> BindsModule
    AppModule --> DeviceRepository
    AppModule --> BleManager
    
    %% 样式定义
    classDef uiLayer fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef businessLayer fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef serviceLayer fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef dataLayer fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef hardwareLayer fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef deviceLayer fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    classDef diLayer fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    
    class MainActivity,HomeScreen,FunctionScreen,PairingScreen,SettingScreen,TestActivity,HomeViewModel,FunctionViewModel,PairingViewModel,LedColorViewModel uiLayer
    class DeviceRepository,SettingsRepository,FunctionExecutor,AppExecutor,CarExecutor,MediaExecutor,VirtualCarExecutor,MeiJiaCarExecutor businessLayer
    class BleService,BleManager,SoundManager,BootReceiver serviceLayer
    class RoomDB,DataStore,SharedPrefs,DeviceDao,ButtonMappingDao,FunctionsConfig,DefaultFunctions dataLayer
    class BleConstants,BleAuth,CarAPI,MeiJiaAPI,VirtualCarAPI,MediaService,AppService,NotificationService hardwareLayer
    class LingDongTie,CarSystem deviceLayer
    class HiltApp,AppModule,BindsModule diLayer
```

## 架构说明

### 1. 表现层 (Presentation Layer)
- **MainActivity**: 主界面容器，使用Jetpack Compose构建UI
- **各种Screen**: 采用MVVM模式，通过ViewModel管理状态
- **导航**: 使用Compose Navigation进行页面导航

### 2. 业务逻辑层 (Business Logic Layer)
- **Repository模式**: 统一数据访问接口
- **功能执行器**: 根据不同平台和功能类型分发执行逻辑
- **车机适配**: 支持镁佳、梧桐等不同车机平台

### 3. 服务层 (Service Layer)
- **BleService**: 前台服务，维持蓝牙连接和处理按键事件
- **BleManager**: 管理蓝牙连接、扫描、配对等操作
- **开机启动**: 支持系统启动时自动启动服务

### 4. 数据层 (Data Layer)
- **Room数据库**: 存储设备信息和按键映射
- **DataStore**: 存储应用配置
- **配置文件**: XML格式的功能配置

### 5. 硬件抽象层 (Hardware Abstraction Layer)
- **蓝牙通信**: 标准BLE协议通信
- **车机集成**: 多种车机平台API适配
- **系统服务**: Android系统服务调用

### 6. 依赖注入
- **Hilt**: 统一依赖注入管理
- **模块化**: 按功能划分依赖注入模块

## 核心特性

1. **多设备支持**: 支持按键型(L0)、旋钮型(L1)、歌尔型(E1)设备
2. **车机适配**: 支持镁佳、梧桐等多种车机平台
3. **功能丰富**: 应用启动、车机控制、媒体控制等
4. **实时通信**: 蓝牙BLE协议实时通信
5. **持久化**: 设备配置和功能映射持久化存储
6. **后台服务**: 前台服务保证连接稳定性

## 技术栈

- **UI**: Jetpack Compose + Material 3
- **架构**: MVVM + Repository Pattern
- **依赖注入**: Hilt
- **数据库**: Room
- **配置存储**: DataStore
- **蓝牙通信**: Android BLE API
- **车机集成**: Android Car API + 厂商API
- **日志**: Timber
- **协程**: Kotlin Coroutines + Flow
